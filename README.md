# AvtoFotaNew

**–õ—ë–≥–∫–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è OTA-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è ESP32 –∏ ESP8266**  
—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **–±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ –∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**,  
**–ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**, **Watchdog-safe** –∏ –ø–æ–ª–Ω–æ–π —Å–≤–æ–±–æ–¥–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
(MQTT, Serial, –¥–∏—Å–ø–ª–µ–∏, Home Assistant –∏ —Ç.–¥.).

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ ESP32 –∏ ESP8266
- ‚úÖ HTTP / HTTPS
- ‚úÖ –ü—Ä–æ—à–∏–≤–∫–∏ > 1 MB
- ‚úÖ –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π OTA (`updateNOW`)
- ‚úÖ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π OTA (`update` –≤ `loop`)
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å 0‚Äì100%
- ‚úÖ Callback –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- ‚úÖ Watchdog-safe
- ‚úÖ MQTT / Serial / Display ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- ‚úÖ Arduino IDE –∏ PlatformIO

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```Text
AvtoFotaNew/
‚îú‚îÄ AvtoFotaNew.h
‚îú‚îÄ AvtoFotaNew.cpp
‚îú‚îÄ examples/
‚îÇ ‚îú‚îÄ BlockUpdate/
‚îÇ ‚îú‚îÄ LoopUpdate/
‚îÇ ‚îî‚îÄ MqttOtaProgress/
‚îú‚îÄ library.properties
‚îú‚îÄ library.json
‚îî‚îÄ README.md
```


## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### Arduino IDE
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞–ø–∫—É `AvtoFotaNew` –≤: Documents/Arduino/libraries/
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Arduino IDE

### PlatformIO
–ü–æ–º–µ—Å—Ç–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤ –ø–∞–ø–∫—É `lib/` –ø—Ä–æ–µ–∫—Ç–∞  
–∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —á–µ—Ä–µ–∑ `lib_deps`.

---

## ‚öôÔ∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç—ã

### ESP32
- **Partition Scheme** ‚Üí `Default with OTA`

### ESP8266
- **Flash Size** ‚Üí `4MB (OTA)`
- –ò–Ω–∞—á–µ OTA —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç

---

## üîó JSON-–º–∞–Ω–∏—Ñ–µ—Å—Ç

–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ `firmware.json`:

```json
{
"version": "1.1.0",
"notes": "Bug fixes and stability improvements",
"bin": "https://yourserver.com/firmware.bin"
}
```
## üß† –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

1. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç JSON-–º–∞–Ω–∏—Ñ–µ—Å—Ç

2. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–µ—Ä—Å–∏–∏

3. –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–æ–≤–∞—è ‚Äî —Å–∫–∞—á–∏–≤–∞–µ—Ç .bin

4. –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É

5. –ü–µ—Ä–µ–¥–∞—ë—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å (callback)

6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

   
## üß† –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

-–ë–ª–æ–∫–∏—Ä—É—é—â–∏–π OTA ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

-–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π OTA ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ loop(), –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

-–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö

-MQTT / Serial / Display ‚Äî –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ callback, –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —á–∏—Å—Ç–æ–π

## üìå API –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
---
### üîπ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
```cpp
AvtoFotaNew(const char* version);
``` 
–°–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç OTA.
`version ` ‚Äî —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏

### üîπ setManifestURL()
```cpp
void setManifestURL(const char* url);
```
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç URL JSON-–º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.

### üîπ setDebug()

```cpp
void setDebug(bool enable);
```
–í–∫–ª—é—á–∞–µ—Ç / –æ—Ç–∫–ª—é—á–∞–µ—Ç –≤—ã–≤–æ–¥ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ Serial.

### üîπ setProgressCallback()

```cpp
void setProgressCallback(std::function<void(uint8_t)> callback);
```
Callback –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ OTA (0‚Äì100%).

-–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

-Serial

-MQTT

-–¥–∏—Å–ø–ª–µ–µ–≤

-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### üîπ getchekupdate()

```cpp
bool getchekupdate();
```
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
`true` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ
`false` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞

### üîπ getupdate()
```cpp
bool getupdate(String &version, String &notes);
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
`version` ‚Äî –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
`notes` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### üîπ getpercentupdate()
```cpp
uint8_t getpercentupdate() const;
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ OTA.
 üìå –í –±–ª–æ–∫–∏—Ä—É—é—â–µ–º —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ callback.

### üîπ getVER()

```cpp
String getVER() const;
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ—à–∏–≤–∫–∏.

---

## üîÑ OTA-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### üîí –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º
```cpp
bool updateNOW(bool autorestart = true);
```

-–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ –∫–æ–Ω—Ü–∞ OTA

-–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ callback

`autorestart = true` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞

### üîÅ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º
```cpp
bool update(bool autorestart = true);
```
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `loop()`
–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`, –∫–æ–≥–¥–∞ OTA –∑–∞–≤–µ—Ä—à–µ–Ω–æ

### üì° MQTT-–ø—Ä–∏–º–µ—Ä (–ø—Ä–æ–≥—Ä–µ—Å—Å OTA)
```cpp
fota.setProgressCallback([](uint8_t p) {
  mqtt.publish("device/esp32/fota/progress", String(p).c_str());
});
```

üìå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç MQTT ‚Äî —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ
–¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏.

‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
–†–µ–∂–∏–º OTA	–ü—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ `getpercentupdate()`	`Callback`
–ë–ª–æ–∫–∏—Ä—É—é—â–∏–π	‚ùå	‚úÖ
–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π	‚úÖ	‚úÖ
üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ OTA
MQTT, Serial, –¥–∏—Å–ø–ª–µ–∏ –∏ –ª–æ–≥–∏–∫–∞ ‚Äî –∑–∞–¥–∞—á–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–≠—Ç–æ –¥–µ–ª–∞–µ—Ç AvtoFotaNew:

-–ª—ë–≥–∫–æ–π

-—Å—Ç–∞–±–∏–ª—å–Ω–æ–π

-—Ä–∞—Å—à–∏—Ä—è–µ–º–æ–π
---
## üë®‚Äçüíª –ê–≤—Ç–æ—Ä

### Aliaksandr Labada
GitHub: https://github.com/eu1abg

## üèÅ –ò—Ç–æ–≥

AvtoFotaNew ‚Äî —ç—Ç–æ –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:

-–ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å

-–ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å

-–±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å
